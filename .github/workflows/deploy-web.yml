name: Deploy Web Frontend to Digital Ocean

on:
  push:
    branches: [ main, master ]
    paths:
      - 'web/**'
      - '.github/workflows/deploy-web.yml'
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'Force deployment even if no changes'
        required: false
        default: 'false'

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install dependencies
        working-directory: ./web
        run: |
          echo "Installing web dependencies..."
          # Work around npm bug with optional dependencies (https://github.com/npm/cli/issues/4828)
          # Remove node_modules to force fresh install of optional deps
          rm -rf node_modules
          # Use npm install (handles optional deps better than npm ci for this bug)
          npm install --include=optional
          # Explicitly install platform-specific optional dependencies (workaround for npm bug)
          echo "Ensuring platform-specific optional dependencies are installed..."
          npm install --save-optional @rollup/rollup-linux-x64-gnu@4.52.5 lightningcss-linux-x64-gnu@1.30.2 @tailwindcss/oxide-linux-x64-gnu@4.1.16 || true
          echo "Verifying package.json scripts..."
          grep -A 10 '"scripts"' package.json || echo "package.json not found"

      - name: Build production bundle
        working-directory: ./web
        env:
          # Empty = same-origin in browser (https://tlpnetwork.com/api). Fixes mixed content when site is HTTPS.
          VITE_API_URL: ''
          # Pre-launch password gate â€“ set secrets in GitHub repo Settings â†’ Secrets
          VITE_PASSWORD_PROTECT: ${{ secrets.VITE_PASSWORD_PROTECT }}
          VITE_ACCESS_PASSWORD: ${{ secrets.VITE_ACCESS_PASSWORD }}
        run: npm run build

      - name: Upload build artifacts
        uses: appleboy/scp-action@v0.1.7
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          source: "web/dist/"
          target: "/tmp/tlp-web-build"
          strip_components: 2
          rm: false

      - name: Deploy Web Frontend
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.DROPLET_HOST }}
          username: ${{ secrets.DROPLET_USER }}
          key: ${{ secrets.DROPLET_SSH_KEY }}
          port: 22
          timeout: 120s
          script: |
            echo "ğŸš€ Deploying web frontend..."
            echo "ğŸ“ Setting up web root directory..."
            sudo mkdir -p /var/www/tlp-web
            echo "ğŸ§¹ Clearing old files..."
            sudo rm -rf /var/www/tlp-web/* /var/www/tlp-web/.* 2>/dev/null || true
            echo "ğŸ“ Checking uploaded build files..."
            ls -la /tmp/tlp-web-build/ 2>/dev/null || echo "âš ï¸ /tmp/tlp-web-build not found, checking alternatives..."
            if [ -d "/tmp/tlp-web-build/dist" ]; then
              echo "ğŸ“¦ Found files in /tmp/tlp-web-build/dist"
              sudo cp -r /tmp/tlp-web-build/dist/* /var/www/tlp-web/ || { echo "âŒ Failed to copy files from /tmp/tlp-web-build/dist"; exit 1; }
            elif [ -d "/tmp/tlp-web-build" ] && [ "$(ls -A /tmp/tlp-web-build 2>/dev/null)" ]; then
              echo "ğŸ“¦ Found files in /tmp/tlp-web-build"
              sudo cp -r /tmp/tlp-web-build/* /var/www/tlp-web/ || { echo "âŒ Failed to copy files from /tmp/tlp-web-build"; exit 1; }
            else
              echo "âŒ Build directory not found or empty at /tmp/tlp-web-build"
              echo "Contents of /tmp:"
              ls -la /tmp/ | grep -i tlp || echo "No TLP directories found"
              echo "Attempting to find build files..."
              find /tmp -name "index.html" -type f 2>/dev/null | head -5
              exit 1
            fi
            echo "ğŸ” Verifying files were copied..."
            if [ ! -f "/var/www/tlp-web/index.html" ]; then
              echo "âŒ index.html not found in web root!"
              echo "Contents of /var/www/tlp-web:"
              ls -la /var/www/tlp-web/ | head -20
              exit 1
            fi
            echo "âœ… Found index.html - files copied successfully"
            echo "ğŸ“Š Build contents:"
            ls -lah /var/www/tlp-web/ | head -10
            echo "ğŸ” Setting permissions..."
            sudo chown -R www-data:www-data /var/www/tlp-web || { echo "âŒ Failed to set ownership"; exit 1; }
            sudo chmod -R 755 /var/www/tlp-web || { echo "âš ï¸ Failed to set permissions"; true; }
            echo "ğŸ§¹ Cleaning up temporary files..."
            sudo rm -rf /tmp/tlp-web-build || true
            echo "ğŸ§¹ Clearing nginx cache..."
            sudo rm -rf /var/cache/nginx/* 2>/dev/null || true
            echo "ğŸ”„ Testing nginx configuration..."
            sudo nginx -t || { echo "âŒ Nginx configuration test failed"; exit 1; }
            echo "ğŸ”„ Reloading nginx..."
            sudo systemctl reload nginx || { echo "âŒ Nginx reload failed"; exit 1; }
            echo "â³ Waiting 2 seconds for nginx to fully reload..."
            sleep 2
            echo "âœ… Web frontend deployed successfully!"
            echo "ğŸ“‹ Deployment summary:"
            echo "  - Files deployed to: /var/www/tlp-web"
            echo "  - Nginx reloaded: Yes"
            echo "  - Timestamp: $(date)"
